<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>خلسه</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #b71c1c; /* A darker, more blood-like red */
            --background-color: #000;
            --text-color: #cfd8dc;
        }
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0;
            background: var(--background-color);
            cursor: none; font-family: 'Vazirmatn', sans-serif;
            user-select: none; overflow: hidden;
        }
        #app-container, #visual-engine, #ui-layer {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
        }
        #background-image {
            position: fixed;
            top: -5%; left: -5%;
            width: 110%; height: 110%;
            background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2071&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            z-index: 1;
            transition: filter 3s ease-in-out, transform 3s ease-in-out;
            filter: blur(2px) brightness(0.6);
            transform: scale(1);
        }
        @keyframes screen-shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        .shake-effect { animation: screen-shake 0.5s ease-in-out; }
        #particle-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        #ui-layer { z-index: 10; display: flex; justify-content: center; align-items: center; text-align: center; padding: 1rem; color: var(--text-color); }
        #content-wrapper { width: 95%; max-width: 800px; z-index: 11; position: relative; }
        #cursor-follower { position: fixed; width: 22px; height: 22px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.8); pointer-events: none; z-index: 9999; mix-blend-mode: difference; transition: transform 0.1s ease-out, opacity 0.3s ease; will-change: transform; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; filter: blur(10px); transform: translateY(20px) scale(0.98); } to { opacity: 1; filter: blur(0); transform: translateY(0) scale(1); } }
        @keyframes fadeOut { from { opacity: 1; filter: blur(0); } to { opacity: 0; filter: blur(10px); transform: scale(0.98); } }
        
        .interactive-button, .interactive-submit, .mic-button {
            background: rgba(0,0,0,0.4); backdrop-filter: blur(8px);
            border: 1px solid var(--primary-color); color: var(--primary-color);
            padding: 12px 24px; font-size: 1.1rem; transition: all 0.2s; margin: 8px;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .interactive-button:hover:not(:disabled), .interactive-submit:hover, .mic-button:hover:not(:disabled) { background: var(--primary-color); color: var(--background-color); box-shadow: 0 0 25px var(--primary-color); transform: translateY(-2px) scale(1.05); }
        .interactive-button:disabled, .mic-button:disabled { opacity: 0.4; cursor: not-allowed; }
        .mic-button.is-listening { background: var(--primary-color); color: var(--background-color); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(183, 28, 28, 0.7); } 70% { box-shadow: 0 0 0 25px rgba(183, 28, 28, 0); } 100% { box-shadow: 0 0 0 0 rgba(183, 28, 28, 0); } }

        /* Stage specific styles */
        #stroop-prompt { font-size: 4rem; font-weight: 900; text-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        #generated-image-container { max-width: 90%; max-height: 400px; margin: 1rem auto; background: rgba(0,0,0,0.5); padding: 10px; border: 1px solid #444; }
        #generated-image { max-width: 100%; max-height: 380px; object-fit: contain; }
        .image-loader { color: white; font-size: 1.5rem; }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="visual-engine">
            <div id="background-image"></div>
            <canvas id="particle-overlay"></canvas>
        </div>
        <div id="ui-layer"><div id="content-wrapper"></div></div>
    </div>
    <div id="cursor-follower"></div>

    <script>
        // ===================================================================================
        // UTILITIES & HARDWARE
        // ===================================================================================
        class NonRetryableError extends Error {
            constructor(message) { super(message); this.name = "NonRetryableError"; }
        }
        const Hardware = {
            vibrate(pattern = [200, 100, 200]) {
                if ('vibrate' in navigator) {
                    try { navigator.vibrate(pattern); } catch (e) { console.warn("Could not vibrate:", e); }
                }
            },
            shakeScreen() {
                const app = document.getElementById('app-container');
                app.classList.add('shake-effect');
                setTimeout(() => app.classList.remove('shake-effect'), 500);
            }
        };

        // ===================================================================================
        // CORE MODULE: The Game's Soul
        // ===================================================================================
        const Engine = {
            state: {
                currentFlow: 'intro',
                distortion: 0.0,
                userProfile: { choices: [], personality: 'رفیق بازاری' },
                lastInput: null,
                isAudioReady: false,
                micPermission: 'prompt',
            },

            init() {
                UI.init();
                Visuals.init();
                UI.renderIntro();
            },

            async primeSystemAndStart() {
                UI.renderLoader("در انتظار اجازه‌ی تو...");
                try {
                    if (!this.state.isAudioReady) {
                        await Tone.start();
                        Audio.init();
                        this.state.isAudioReady = true;
                    }
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    this.state.micPermission = 'granted';
                    this.startExperience();
                } catch (err) {
                    console.error("Permission denied:", err);
                    this.state.micPermission = 'denied';
                    UI.renderLoader("دسترسی به میکروفون رد شد. تجربه بدون صدا ادامه پیدا می‌کنه...");
                    setTimeout(() => this.startExperience(), 2500);
                }
            },

            startExperience() { this.transitionTo('loading_stage'); },

            async transitionTo(flowState, context = {}) {
                this.state.currentFlow = flowState;
                switch (flowState) {
                    case 'loading_stage':
                        await UI.renderLoader("ذهن داره برات یه چیزی جور می‌کنه...");
                        const stageType = this.determineNextStage();
                        try {
                            if (stageType === 'image_generation_test') {
                                this.transitionTo('generating_image');
                            } else {
                                const stageData = await AI.generateStage(stageType, this.state.userProfile);
                                this.transitionTo('stage', { type: stageType, data: stageData });
                            }
                        } catch (e) { this.handleAIError(e, () => this.transitionTo('loading_stage')); }
                        break;
                    
                    case 'generating_image':
                        await UI.renderLoader("در حال خلق یک تصویر از اعماق ذهن...");
                        try {
                            const imageData = await AI.generateImage(this.state.userProfile);
                             this.transitionTo('stage', { type: 'image_generation_test', data: imageData });
                        } catch (e) { this.handleAIError(e, () => this.transitionTo('loading_stage')); }
                        break;

                    case 'stage':
                        UI.renderStage(context.type, context.data);
                        if (context.type === 'vibration_event') {
                            Hardware.vibrate();
                            Hardware.shakeScreen();
                        }
                        break;

                    case 'loading_feedback':
                        await UI.renderLoader("دارم حرفاتو هضم می‌کنم...");
                        try {
                            const feedbackData = await AI.generateFeedback(this.state.lastInput, this.state.userProfile.personality);
                            this.transitionTo('feedback', { data: feedbackData });
                        } catch (e) { this.handleAIError(e, () => this.transitionTo('loading_feedback')); }
                        break;

                    case 'feedback':
                        await UI.renderFeedback(context.data.comment);
                        setTimeout(() => this.transitionTo('loading_stage'), 6000);
                        break;

                    default:
                        this.handleAIError(new Error("Flow state ناشناخته."), () => this.startExperience());
                }
            },
            
            determineNextStage() {
                const stages = ['question', 'stroop_test', 'word_association'];
                if (this.state.distortion > 3) stages.push('moral_dilemma');
                if (this.state.distortion > 6) stages.push('image_generation_test');
                if (this.state.distortion > 9 && Math.random() < 0.3) stages.push('vibration_event'); // Rare event
                if (this.state.distortion > 12 && this.state.userProfile.choices.length > 3) stages.push('memory_corruption');
                
                return stages[Math.floor(Math.random() * stages.length)];
            },
            
            handleAIError(error, retryFunction) {
                console.error("AI Error:", error);
                if (error instanceof NonRetryableError) {
                    UI.renderError(`ارتباط با ذهن قطع شد: ${error.message}.`);
                } else {
                    UI.renderLoader("امواج مغزی ضعیفه... دارم دوباره سعی می‌کنم.");
                    setTimeout(retryFunction, 7000);
                }
            },

            processUserInput(inputData) {
                this.state.lastInput = inputData;
                this.state.userProfile.choices.push(inputData);
                
                const collapseAmount = inputData.collapse || 1.0;
                this.state.distortion += collapseAmount;

                if (this.state.distortion > 15) this.state.userProfile.personality = 'روانی و بی‌پرده';
                else if (this.state.distortion > 8) this.state.userProfile.personality = 'تیکه‌انداز و بی‌رحم';

                Visuals.update(this.state.distortion);
                if (this.state.isAudioReady) Audio.update(this.state.distortion);
                this.transitionTo('loading_feedback');
            }
        };
        
        // ===================================================================================
        // UI MODULE
        // ===================================================================================
        const UI = {
            init() { /* ... unchanged ... */
                const cursor = document.getElementById('cursor-follower');
                if (cursor) {
                    window.addEventListener('mousemove', e => {
                        cursor.style.opacity = '1';
                        window.requestAnimationFrame(() => {
                           cursor.style.transform = `translate3d(${e.clientX}px, ${e.clientY}px, 0)`;
                        });
                    });
                    document.body.addEventListener('mouseleave', () => { cursor.style.opacity = '0'; });
                }
            },
            _setContent(html) {
                return new Promise(res => {
                    const wrapper = document.getElementById('content-wrapper');
                    wrapper.style.animation = 'fadeOut 0.5s forwards ease-in-out';
                    setTimeout(() => {
                        wrapper.innerHTML = html;
                        wrapper.style.animation = `fadeIn 1s forwards ease-in-out`;
                        res();
                    }, 500);
                });
            },
            
            renderIntro() {
               this._setContent(`
                    <h1 class="text-6xl md:text-7xl font-black text-white" style="text-shadow: 0 0 15px rgba(255,255,255,0.3);">خلسه</h1>
                    <p class="mt-4 text-gray-400 text-xl">یه ذهن منتظرته. جرئتشو داری؟</p>
                    <button id="start-btn" class="interactive-button mt-8">بزن بریم</button>
                `).then(() => {
                    document.getElementById('start-btn').onclick = () => Engine.primeSystemAndStart();
                });
            },
            renderLoader(text) { return this._setContent(`<p class="text-2xl text-gray-400">${text}</p>`); },
            renderError(msg) { return this._setContent(`<p class="text-2xl text-red-400">${msg}</p>`); },
            renderFeedback(comment) { return this._setContent(`<p class="text-2xl font-bold text-blue-300">"${comment}"</p>`); },

            renderStage(type, data) {
                let html = '';
                switch(type) {
                    case 'question':
                        html = `<p class="text-2xl md:text-3xl mb-8">${data.prompt}</p><div data-stage-type="${type}">${data.choices.map(c => `<button class="interactive-button" data-collapse="${c.collapse}">${c.text}</button>`).join('')}</div>`;
                        break;
                    case 'stroop_test':
                        html = `<p class="text-2xl md:text-3xl mb-6">${data.prompt}</p>
                                <p id="stroop-prompt" style="color: ${data.display_color};">${data.word}</p>
                                <div class="color-palette mt-8" data-stage-type="${type}" data-correct="${data.correct_answer}">${data.choices.map(c => `<div class="color-swatch" style="background-color: ${c};" data-choice="${c}"></div>`).join('')}</div>`;
                        break;
                    case 'image_generation_test':
                         html = `<p class="text-2xl md:text-3xl mb-4">${data.prompt}</p>
                                 <div id="generated-image-container">
                                     <img id="generated-image" src="${data.imageUrl}" alt="تصویر خلق شده توسط هوش مصنوعی">
                                 </div>
                                 <div class="flex flex-col items-center gap-4 mt-4">
                                     <input type="text" id="text-input" class="interactive-input" autocomplete="off" placeholder="چه حسی داری؟...">
                                     <button id="submit-btn" class="interactive-submit">بفرست</button>
                                 </div>`;
                        break;
                    case 'vibration_event':
                        html = `<p class="text-3xl md:text-4xl font-black text-red-500">${data.prompt}</p>`;
                        setTimeout(() => Engine.processUserInput({ type: type, choice: 'لرزش احساس شد', collapse: 3 }), 3000);
                        break;
                    default: // word_association, moral_dilemma, memory_corruption
                        html = `<p class="text-2xl md:text-3xl mb-8">${data.prompt}</p>
                                <div class="flex flex-col items-center gap-4">
                                    <input type="text" id="text-input" class="interactive-input" autocomplete="off" placeholder="جوابتو بنویس...">
                                    <div class="flex items-center gap-4 mt-4">
                                        <button id="submit-btn" class="interactive-submit">بفرست</button>
                                        <button id="mic-btn" class="mic-button" ${Engine.state.micPermission !== 'granted' ? 'disabled' : ''}>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>
                                        </button>
                                    </div>
                                </div>`;
                }
                this._setContent(html).then(() => this.setupStageListeners(type));
            },
            
            setupStageListeners(type) {
                if (type === 'question') {
                    document.querySelectorAll('.interactive-button').forEach(btn => {
                        btn.onclick = () => Engine.processUserInput({ type: type, choice: btn.innerText, collapse: parseFloat(btn.dataset.collapse) });
                    });
                } else if (type === 'stroop_test') {
                    const container = document.querySelector('[data-stage-type="stroop_test"]');
                    const correctAnswer = container.dataset.correct;
                    document.querySelectorAll('.color-swatch').forEach(swatch => {
                        swatch.onclick = () => {
                            const isCorrect = swatch.dataset.choice === correctAnswer;
                            Engine.processUserInput({ type: type, choice: swatch.dataset.choice, collapse: isCorrect ? 0.5 : 4.0 });
                        };
                    });
                } else if (type === 'image_generation_test' || type.includes('association') || type.includes('dilemma') || type.includes('corruption')) {
                     const submitBtn = document.getElementById('submit-btn');
                     const textInput = document.getElementById('text-input');
                     const micBtn = document.getElementById('mic-btn');

                    const action = () => { if (textInput.value.trim()) Engine.processUserInput({ type: type, choice: textInput.value, collapse: 1 + Math.floor(textInput.value.length / 10) }); };
                    if (submitBtn) submitBtn.onclick = action;
                    if (textInput) textInput.onkeydown = e => { if (e.key === 'Enter') action(); };
                    if (micBtn && Engine.state.micPermission === 'granted') micBtn.onclick = () => Voice.listen();
                }
            }
        };

        // ===================================================================================
        // VOICE, AI, VISUALS, AUDIO MODULES
        // ===================================================================================
        const Voice = { /* ... unchanged from previous version, as it's now correctly controlled by Engine ... */ 
            recognition: null,
            isSupported: ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window),

            listen() {
                if (!this.isSupported || Engine.state.micPermission !== 'granted') return;
                
                if (this.recognition && this.recognition.abort) this.recognition.abort();

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                this.recognition.continuous = false;
                this.recognition.lang = 'fa-IR';
                this.recognition.interimResults = true;
                
                const micBtn = document.getElementById('mic-btn');
                const textInput = document.getElementById('text-input');
                let final_transcript = '';

                this.recognition.onstart = () => { micBtn.classList.add('is-listening'); textInput.placeholder = 'دارم گوش میدم...'; };
                this.recognition.onend = () => {
                    micBtn.classList.remove('is-listening');
                    if (final_transcript.trim()) {
                        const stageTypeElement = document.querySelector('[data-stage-type]');
                        const stageType = stageTypeElement ? stageTypeElement.dataset.stageType : 'voice_input';
                        Engine.processUserInput({ type: stageType, choice: final_transcript });
                    } else { textInput.placeholder = 'جوابتو بنویس...'; }
                };
                this.recognition.onerror = (event) => { console.error('Voice recognition error:', event.error); textInput.placeholder = `خطا: ${event.error}`; };
                this.recognition.onresult = (event) => {
                    let interim_transcript = '';
                    final_transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) final_transcript += event.results[i][0].transcript;
                        else interim_transcript += event.results[i][0].transcript;
                    }
                    textInput.value = final_transcript || interim_transcript;
                };
                try { this.recognition.start(); } catch(e) { console.error("Recognition already started."); }
            }
        };

        const AI = {
            apiKey: "", // Leave empty, it will be handled by the environment

            async _queryGemini(prompt) {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`;
                
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    
                    if (result.promptFeedback && result.promptFeedback.blockReason) {
                        throw new NonRetryableError(`درخواست توسط API بلاک شد: ${result.promptFeedback.blockReason}`);
                    }
                    const text = result.candidates[0].content.parts[0].text;
                    return JSON.parse(text.replace(/```json|```/g, '').trim());
                } catch (error) {
                    console.error("Gemini Query Error:", error);
                    if (error instanceof NonRetryableError) throw error;
                    throw new Error("پاسخ نامعتبر از Gemini.");
                }
            },

            async generateImage(profile) {
                const imagePromptGenerator = `یک پرامپت کوتاه (حدود ۱۰ تا ۱۵ کلمه) برای ساختن یک تصویر سورئال، وهم‌آور و روانشناختی به زبان انگلیسی بساز. این تصویر باید حسی از تنهایی، راز یا اضطراب را القا کند. فقط خود پرامپت را به عنوان خروجی بده. مثال: "a single red chair in an empty, decaying grand ballroom, dust floating in a single sunbeam"`;
                 const imagePromptPayload = { contents: [{ role: "user", parts: [{ text: imagePromptGenerator }] }] };
                 const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`;
                
                const promptResponse = await fetch(geminiApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(imagePromptPayload) });
                const promptResult = await promptResponse.json();
                const imagePrompt = promptResult.candidates[0].content.parts[0].text.trim();

                const payload = { instances: [{ prompt: imagePrompt }], parameters: { "sampleCount": 1 } };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${this.apiKey}`;

                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`Imagen API Error: ${response.status}`);
                    const result = await response.json();
                    if (result.predictions && result.predictions[0].bytesBase64Encoded) {
                         return {
                            prompt: "به این تصویر نگاه کن. اولین کلمه‌ای که به ذهنت میاد چیه؟",
                            imageUrl: `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`
                        };
                    }
                    throw new Error("پاسخ نامعتبر از Imagen.");
                } catch (error) {
                    console.error("Imagen API Error:", error);
                    throw error;
                }
            },

            async generateStage(type, profile) {
                let prompt;
                const personality = profile.personality;
                switch (type) {
                    case 'question':
                        prompt = `یه سوال دو گزینه‌ای بساز که آدمو تو فشار بذاره. موضوعش یه چیزی مثل انتخاب بین دوتا بدبختی باشه. لحنت ${personality} باشه. خروجی JSON: {"prompt": "متن سوال", "choices": [{"text": "گزینه ۱", "collapse": امتیاز}, {"text": "گزینه ۲", "collapse": امتیاز}]}`;
                        break;
                    case 'stroop_test':
                        prompt = `یه بازی روانی "استروپ" بساز. یه کلمه که اسم یه رنگه، با یه رنگ دیگه نمایش داده می‌شه. کاربر باید رنگی که کلمه باهاش نوشته شده رو انتخاب کنه. گیج کننده باشه. خروجی JSON: {"prompt": "کلمه‌ی زیر رو بخون و رنگش رو انتخاب کن، نه کلمه‌ رو", "word": "قرمز", "display_color": "blue", "choices": ["red", "blue", "green"], "correct_answer": "blue"}`;
                        break;
                    case 'vibration_event':
                        prompt = `یه جمله خیلی کوتاه و نگران‌کننده برای یه رویداد شوکه‌کننده (لرزش) بساز. خروجی JSON: {"prompt": "صبر کن... یه چیزی درست نیست."}`;
                        break;
                    default: // word_association, moral_dilemma, etc.
                        prompt = `یه سوال عمیق یا یه دوراهی اخلاقی با لحن ${personality} بساز که جوابش متنی باشه. یه کلمه‌ی کلیدی مثل "انتقام"، "قدرت" یا "فراموشی" توش باشه. خروجی JSON: {"prompt": "متن سوال"}`;
                }
                return this._queryGemini(prompt);
            },
            
            async generateFeedback(lastInput, personality) {
                const prompt = `رفیقت به این جواب رسیده: "${lastInput.choice}". با لحن ${personality} یه تیکه‌ی کوتاه و خودمونی بهش بنداز که به فکر فرو بره. انگار داری مچشو می‌گیری. مثال: "هه! فکر کردی با این جواب چیزی عوض میشه؟". خروجی JSON: {"comment": "تیکه‌ی تو"}`;
                return this._queryGemini(prompt);
            }
        };

        const Visuals = { /* ... unchanged ... */ 
            bgElement: null, ctx: null, canvas: null, width: 0, height: 0, particles: [],
            init() {
                this.bgElement = document.getElementById('background-image');
                this.canvas = document.getElementById('particle-overlay');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize(), false);
                for(let i = 0; i < 50; i++) {
                    this.particles.push({
                        x: Math.random() * this.width, y: Math.random() * this.height,
                        vx: (Math.random() - 0.5) * 0.3, vy: (Math.random() - 0.5) * 0.3,
                        radius: Math.random() * 1.5 + 0.5,
                    });
                }
                this.loop();
            },
            resize() { this.width = this.canvas.width = window.innerWidth; this.height = this.canvas.height = window.innerHeight; },
            update(distortion) {
                const blur = Math.min(20, 2 + distortion * 1.2);
                const brightness = Math.max(0.2, 0.6 - distortion * 0.04);
                const scale = 1 + distortion * 0.015;
                const saturate = Math.max(0.5, 1 - distortion * 0.05);
                this.bgElement.style.filter = `blur(${blur}px) brightness(${brightness}) saturate(${saturate})`;
                this.bgElement.style.transform = `scale(${scale})`;
            },
            loop() {
                this.ctx.clearRect(0, 0, this.width, this.height);
                this.ctx.fillStyle = 'rgba(200, 210, 220, 0.3)';
                for(const p of this.particles) {
                    p.x += p.vx; p.y += p.vy;
                    if(p.x < 0 || p.x > this.width) p.vx *= -1;
                    if(p.y < 0 || p.y > this.height) p.vy *= -1;
                    this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2); this.ctx.fill();
                }
                requestAnimationFrame(() => this.loop());
            }
        };
        const Audio = { /* ... unchanged ... */ 
            isSetup: false,
            init() {
                if (this.isSetup) return;
                this.reverb = new Tone.Reverb({ decay: 10, wet: 0.7 }).toDestination();
                this.wind = new Tone.Noise("brown").connect(
                    new Tone.AutoFilter({ frequency: "16m", baseFrequency: 80, octaves: 5 }).connect(this.reverb)
                );
                this.wind.volume.value = -30;
                this.wind.start();
                this.isSetup = true;
            },
            update(distortion) {
                if (!this.isSetup) return;
                const newVolume = -30 + (distortion * 1.2);
                this.wind.volume.rampTo(Math.min(-12, newVolume), 4);
                this.reverb.wet.rampTo(Math.min(0.9, 0.7 + distortion * 0.02), 4);
            }
        };

        // --- APPLICATION LAUNCH ---
        Engine.init();
    </script>
</body>
</html>

